---
// WorldMap Component - Visual island-based journey map for gamified learning
// Displays 7 themed islands representing development lifecycle phases

export interface Props {
  currentPathId?: string;
  currentPhase?: string; // Current phase the user is viewing (e.g., '06-operations')
  highlightedTopics?: string[]; // Topics in current learning path
  class?: string;
}

const { currentPathId, currentPhase, highlightedTopics = [], class: className = '' } = Astro.props;

// Phase islands with their themes and positions
// Positions use a 100x70 coordinate system matching the SVG viewBox
const islands = [
  {
    id: '01-discovery-planning',
    name: 'Discovery Cove',
    shortName: 'Discovery',
    description: 'Understanding what to build and why',
    icon: 'compass',
    position: { x: 10, y: 20 },
    color: 'emerald',
    topics: [
      'job-to-be-done',
      'concept-of-operations',
      'threat-modeling',
      'requirements-gathering',
      'scope-setting',
      'resource-identification',
    ],
  },
  {
    id: '02-design',
    name: 'Design Archipelago',
    shortName: 'Design',
    description: 'Architecture and planning before implementation',
    icon: 'pencil',
    position: { x: 30, y: 10 },
    color: 'sky',
    topics: [
      'architecture-decisions',
      'data-modeling',
      'api-design',
      'ui-ux-design',
      'security-design',
      'performance-planning',
      'integration-design',
      'documentation-strategy',
    ],
  },
  {
    id: '03-development',
    name: 'Dev Mountain',
    shortName: 'Development',
    description: 'Writing code that works and is maintainable',
    icon: 'code',
    position: { x: 50, y: 25 },
    color: 'violet',
    topics: [
      'environment-setup',
      'coding-standards',
      'version-control',
      'secure-coding-practices',
      'dependency-management',
      'code-review',
    ],
  },
  {
    id: '04-testing',
    name: 'Testing Reef',
    shortName: 'Testing',
    description: 'Verification, security, accessibility, compliance',
    icon: 'check-circle',
    position: { x: 70, y: 15 },
    color: 'amber',
    topics: [
      'testing-strategy',
      'security-testing',
      'accessibility-testing',
      'performance-testing',
    ],
  },
  {
    id: '05-deployment',
    name: 'Deploy Harbor',
    shortName: 'Deployment',
    description: 'Getting code running reliably in production',
    icon: 'rocket',
    position: { x: 85, y: 30 },
    color: 'orange',
    topics: [
      'deployment-strategy',
      'infrastructure-setup',
      'ci-cd-pipelines',
      'release-management',
    ],
  },
  {
    id: '06-operations',
    name: 'Ops Lighthouse',
    shortName: 'Operations',
    description: 'Keeping systems running and handling incidents',
    icon: 'activity',
    position: { x: 75, y: 50 },
    color: 'rose',
    topics: [
      'monitoring-observability',
      'incident-response',
      'backup-recovery',
      'scaling-optimization',
    ],
  },
  {
    id: '07-iteration',
    name: 'Iteration Atoll',
    shortName: 'Iteration',
    description: 'Learning from outcomes and improving',
    icon: 'refresh-cw',
    position: { x: 50, y: 60 },
    color: 'teal',
    topics: [
      'metrics-analytics',
      'user-feedback',
      'continuous-improvement',
    ],
  },
];

// Connection paths between islands (visual journey lines)
const connections = [
  { from: '01-discovery-planning', to: '02-design' },
  { from: '02-design', to: '03-development' },
  { from: '03-development', to: '04-testing' },
  { from: '04-testing', to: '05-deployment' },
  { from: '05-deployment', to: '06-operations' },
  { from: '06-operations', to: '07-iteration' },
  { from: '07-iteration', to: '01-discovery-planning' }, // Cycle back
];
---

<div class={`world-map-container ${className}`} data-current-path={currentPathId}>
  <div class="world-map">
    <!-- Water background with depth gradient -->
    <div class="ocean-background">
      <div class="water-surface"></div>
      <div class="water-mid"></div>
      <div class="water-deep"></div>
    </div>

    <!-- Compass rose - Mariners-inspired design -->
    <div class="compass-rose" aria-hidden="true" data-compass>
      <svg viewBox="0 0 100 100" fill="none">
        <!-- Outer circle -->
        <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
        <!-- Inner circle -->
        <circle cx="50" cy="50" r="8" stroke="currentColor" stroke-width="1.5" opacity="0.6"/>

        <!-- Cardinal points - trident style like Mariners -->
        <!-- North - red for emphasis -->
        <path class="compass-north" d="M50 5 L54 20 L50 12 L46 20 Z" fill="rgb(239, 68, 68)" opacity="0.9"/>
        <!-- South -->
        <path d="M50 95 L54 80 L50 88 L46 80 Z" fill="currentColor" opacity="0.5"/>
        <!-- East -->
        <path d="M95 50 L80 54 L88 50 L80 46 Z" fill="currentColor" opacity="0.5"/>
        <!-- West -->
        <path d="M5 50 L20 54 L12 50 L20 46 Z" fill="currentColor" opacity="0.5"/>

        <!-- Intercardinal points - smaller -->
        <!-- NE -->
        <path d="M81.82 18.18 L71 25 L75 21 L71 17 Z" fill="currentColor" opacity="0.3"/>
        <!-- SE -->
        <path d="M81.82 81.82 L71 75 L75 79 L71 83 Z" fill="currentColor" opacity="0.3"/>
        <!-- SW -->
        <path d="M18.18 81.82 L29 75 L25 79 L29 83 Z" fill="currentColor" opacity="0.3"/>
        <!-- NW -->
        <path d="M18.18 18.18 L29 25 L25 21 L29 17 Z" fill="currentColor" opacity="0.3"/>

        <!-- Direction letter - N -->
        <text x="50" y="38" text-anchor="middle" font-size="8" font-weight="600" fill="currentColor" opacity="0.7">N</text>
      </svg>
    </div>

    <!-- Connection paths between islands -->
    <svg class="connection-paths" viewBox="0 0 100 70" preserveAspectRatio="none">
      {connections.map((conn) => {
        const fromIsland = islands.find(i => i.id === conn.from);
        const toIsland = islands.find(i => i.id === conn.to);
        if (!fromIsland || !toIsland) return null;

        return (
          <path
            class="island-connection"
            d={`M ${fromIsland.position.x} ${fromIsland.position.y}
                Q ${(fromIsland.position.x + toIsland.position.x) / 2} ${(fromIsland.position.y + toIsland.position.y) / 2 - 5}
                  ${toIsland.position.x} ${toIsland.position.y}`}
            data-from={conn.from}
            data-to={conn.to}
          />
        );
      })}
    </svg>

    <!-- Islands -->
    {islands.map((island) => {
      const hasHighlightedTopics = island.topics.some(t => highlightedTopics.includes(t));
      const topicCount = island.topics.length;
      const isCurrent = currentPhase === island.id;

      // Convert y from 0-70 coordinate system to 0-100% for CSS positioning
      const yPercent = (island.position.y / 70) * 100;

      // Calculate glow intensity based on topic count (3-8 topics range)
      // Normalized to 0-1 scale for CSS calculations
      const minTopics = 3;
      const maxTopics = 8;
      const glowIntensity = (topicCount - minTopics) / (maxTopics - minTopics);

      return (
        <button
          class={`island island-${island.color} ${hasHighlightedTopics ? 'island-highlighted' : ''} ${isCurrent ? 'island-current' : ''}`}
          style={`left: ${island.position.x}%; top: ${yPercent}%; --topic-count: ${topicCount}; --glow-intensity: ${glowIntensity}`}
          data-island-id={island.id}
          data-topics={JSON.stringify(island.topics)}
          aria-label={`${island.name}: ${island.description}. ${topicCount} topics.${isCurrent ? ' You are here.' : ''}`}
        >
          <div class="island-glow"></div>
          <div class="island-body">
            <div class="island-icon">
              <span class="icon-placeholder" data-icon={island.icon}></span>
            </div>
            <div class="island-info">
              <span class="island-name">{island.shortName}</span>
              <span class="island-topic-count">{topicCount} topics</span>
            </div>
          </div>
          <div class="island-progress-ring">
            <svg viewBox="0 0 36 36">
              <circle class="progress-bg" cx="18" cy="18" r="16" />
              <circle
                class="progress-fill"
                cx="18"
                cy="18"
                r="16"
                data-phase={island.id}
              />
            </svg>
          </div>
          {/* Ship marker for current location */}
          {isCurrent && (
            <div class="ship-marker" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/>
              </svg>
            </div>
          )}
        </button>
      );
    })}

    <!-- Current location marker (shown via JS) -->
    <div class="current-location-marker" style="display: none;">
      <div class="marker-pulse"></div>
      <div class="marker-dot"></div>
    </div>
  </div>

  <!-- Legend -->
  <div class="map-legend">
    <div class="legend-item">
      <span class="legend-dot legend-available"></span>
      <span>Available</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot legend-in-progress"></span>
      <span>In Progress</span>
    </div>
    <div class="legend-item">
      <span class="legend-dot legend-completed"></span>
      <span>Completed</span>
    </div>
  </div>
</div>

<script>
  import { loadProgress, getTopicCompletionCount } from '../../utils/progressStore';

  function initWorldMap() {
    const mapContainer = document.querySelector('.world-map-container');
    if (!mapContainer) return;

    const progress = loadProgress();
    const islands = mapContainer.querySelectorAll('.island');

    islands.forEach((island) => {
      const phaseId = island.getAttribute('data-island-id');
      const topicsJson = island.getAttribute('data-topics');
      if (!phaseId || !topicsJson) return;

      const topics = JSON.parse(topicsJson) as string[];
      let totalCompleted = 0;
      let totalPossible = topics.length * 3; // 3 depths per topic

      topics.forEach((topic) => {
        totalCompleted += getTopicCompletionCount(progress, phaseId, topic);
      });

      // Update progress ring
      const progressFill = island.querySelector('.progress-fill') as SVGCircleElement;
      if (progressFill) {
        const percent = totalPossible > 0 ? (totalCompleted / totalPossible) * 100 : 0;
        const circumference = 2 * Math.PI * 16;
        const offset = circumference - (percent / 100) * circumference;
        progressFill.style.strokeDasharray = `${circumference}`;
        progressFill.style.strokeDashoffset = `${offset}`;
      }

      // Add completion state class
      if (totalCompleted === totalPossible && totalPossible > 0) {
        island.classList.add('island-completed');
      } else if (totalCompleted > 0) {
        island.classList.add('island-in-progress');
      }

      // Click handler to navigate to phase page
      island.addEventListener('click', () => {
        window.location.href = `/phases/${phaseId}/`;
      });
    });

    // Update connection paths based on completion
    const connections = mapContainer.querySelectorAll('.island-connection');
    connections.forEach((conn) => {
      const fromId = conn.getAttribute('data-from');
      const fromIsland = mapContainer.querySelector(`[data-island-id="${fromId}"]`);
      if (fromIsland?.classList.contains('island-completed')) {
        conn.classList.add('connection-completed');
      }
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initWorldMap);

  // Re-initialize when storage changes (for live updates)
  window.addEventListener('storage', (e) => {
    if (e.key === 'htbaa_learning_progress') {
      initWorldMap();
    }
  });

  // Compass rose hover animation with smooth ease in/out
  function initCompassAnimation() {
    const compass = document.querySelector('[data-compass]');
    if (!compass) return;

    const svg = compass.querySelector('svg');
    if (!svg) return;

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) return;

    let isHovering = false;
    let currentRotation = 0;
    let targetSpeed = 0; // degrees per frame
    let currentSpeed = 0;
    let animationId: number | null = null;

    const maxSpeed = 2; // degrees per frame (~20 RPM at 60fps)
    const acceleration = 0.05; // ease in rate
    const deceleration = 0.03; // ease out rate (slower for natural feel)

    function animate() {
      // Smoothly adjust speed toward target
      if (isHovering) {
        currentSpeed += (maxSpeed - currentSpeed) * acceleration;
      } else {
        currentSpeed *= (1 - deceleration);
      }

      // Update rotation
      currentRotation += currentSpeed;

      // When slowing down, ease toward nearest 360Â° multiple (north up)
      if (!isHovering && currentSpeed < 0.1) {
        const targetRotation = Math.round(currentRotation / 360) * 360;
        currentRotation += (targetRotation - currentRotation) * 0.08;

        // Stop animation when close enough to north
        if (Math.abs(currentRotation - targetRotation) < 0.5 && currentSpeed < 0.01) {
          currentRotation = targetRotation % 360;
          svg.style.transform = `rotate(${currentRotation}deg)`;
          animationId = null;
          return;
        }
      }

      svg.style.transform = `rotate(${currentRotation}deg)`;
      animationId = requestAnimationFrame(animate);
    }

    compass.addEventListener('mouseenter', () => {
      isHovering = true;
      if (!animationId) {
        animationId = requestAnimationFrame(animate);
      }
    });

    compass.addEventListener('mouseleave', () => {
      isHovering = false;
    });
  }

  document.addEventListener('DOMContentLoaded', initCompassAnimation);
</script>

<style>
  .world-map-container {
    position: relative;
    width: 100%;
    border-radius: 1rem;
    overflow: hidden;
  }

  .world-map {
    position: relative;
    width: 100%;
    aspect-ratio: 100 / 70;
  }

  /* Ocean background layers */
  .ocean-background {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  .water-surface {
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg,
      rgba(56, 189, 248, 0.2) 0%,
      rgba(14, 165, 233, 0.3) 100%
    );
  }

  .water-mid {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 60%;
    background: linear-gradient(180deg,
      transparent 0%,
      rgba(3, 105, 161, 0.2) 100%
    );
  }

  .water-deep {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 30%;
    background: linear-gradient(180deg,
      transparent 0%,
      rgba(12, 74, 110, 0.3) 100%
    );
  }

  /* Compass rose */
  .compass-rose {
    position: absolute;
    bottom: 12px;
    left: 12px;
    width: 60px;
    height: 60px;
    color: rgb(148, 163, 184);
    pointer-events: auto;
    opacity: 0.8;
    cursor: pointer;
  }

  .compass-rose svg {
    width: 100%;
    height: 100%;
  }

  /* Connection paths */
  .connection-paths {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .island-connection {
    fill: none;
    stroke: rgba(148, 163, 184, 0.3);
    stroke-width: 0.3;
    stroke-dasharray: 2 1;
  }

  .island-connection.connection-completed {
    stroke: rgba(52, 211, 153, 0.5);
    stroke-dasharray: none;
  }

  /* Island styling */
  .island {
    position: absolute;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    border: none;
    background: none;
    cursor: pointer;
    padding: 0;
    transition: transform 0.3s ease;
  }

  .island:hover {
    transform: translate(-50%, -50%) scale(1.1);
  }

  .island:focus {
    outline: 2px solid rgb(56, 189, 248);
    outline-offset: 4px;
    border-radius: 50%;
  }

  /* Maldives-style lagoon glow - size and intensity based on topic count */
  .island-glow {
    position: absolute;
    /* Base size: 20px, scales up to 45px based on topic count */
    /* calc: -20px - (intensity * 25px) where intensity is 0-1 */
    inset: calc(-20px - (var(--glow-intensity, 0.5) * 25px));
    border-radius: 50%;
    /* Base opacity 0.25, scales to 0.5 based on intensity */
    background: radial-gradient(
      ellipse at center,
      rgba(34, 211, 238, calc(0.25 + var(--glow-intensity, 0.5) * 0.25)) 0%,
      rgba(34, 211, 238, calc(0.15 + var(--glow-intensity, 0.5) * 0.15)) 30%,
      rgba(6, 182, 212, calc(0.1 + var(--glow-intensity, 0.5) * 0.1)) 50%,
      rgba(8, 145, 178, calc(0.05 + var(--glow-intensity, 0.5) * 0.05)) 70%,
      transparent 100%
    );
    opacity: 1;
    transition: all 0.3s ease;
    /* Blur also scales: 3px base, up to 6px */
    filter: blur(calc(3px + var(--glow-intensity, 0.5) * 3px));
  }

  .island:hover .island-glow,
  .island.island-highlighted .island-glow {
    /* Expand by 5px on hover */
    inset: calc(-25px - (var(--glow-intensity, 0.5) * 25px));
    background: radial-gradient(
      ellipse at center,
      rgba(34, 211, 238, calc(0.35 + var(--glow-intensity, 0.5) * 0.25)) 0%,
      rgba(34, 211, 238, calc(0.2 + var(--glow-intensity, 0.5) * 0.15)) 30%,
      rgba(6, 182, 212, calc(0.15 + var(--glow-intensity, 0.5) * 0.1)) 50%,
      rgba(8, 145, 178, calc(0.08 + var(--glow-intensity, 0.5) * 0.05)) 70%,
      transparent 100%
    );
  }

  .island-body {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgb(30, 41, 59);
    border: 2px solid rgb(51, 65, 85);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  .island:hover .island-body {
    border-color: rgb(100, 116, 139);
  }

  .island-icon {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
  }

  .island-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
  }

  .island-name {
    font-size: 0.6rem;
    font-weight: 600;
    color: rgb(226, 232, 240);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .island-topic-count {
    font-size: 0.5rem;
    color: rgb(148, 163, 184);
  }

  /* Progress ring */
  .island-progress-ring {
    position: absolute;
    inset: -4px;
    pointer-events: none;
  }

  .island-progress-ring svg {
    width: 100%;
    height: 100%;
    transform: rotate(-90deg);
  }

  .progress-bg {
    fill: none;
    stroke: rgba(51, 65, 85, 0.5);
    stroke-width: 2;
  }

  .progress-fill {
    fill: none;
    stroke: rgb(52, 211, 153);
    stroke-width: 2;
    stroke-linecap: round;
    transition: stroke-dashoffset 0.5s ease;
  }

  /* Island color themes - progress ring colors */
  .island-emerald .progress-fill { stroke: rgb(52, 211, 153); }
  .island-sky .progress-fill { stroke: rgb(56, 189, 248); }
  .island-violet .progress-fill { stroke: rgb(167, 139, 250); }
  .island-amber .progress-fill { stroke: rgb(251, 191, 36); }
  .island-orange .progress-fill { stroke: rgb(251, 146, 60); }
  .island-rose .progress-fill { stroke: rgb(251, 113, 133); }
  .island-teal .progress-fill { stroke: rgb(45, 212, 191); }

  /* State modifiers */
  .island.island-completed .island-body {
    border-color: rgb(52, 211, 153);
  }

  .island.island-in-progress .island-body {
    animation: pulse-border 2s infinite;
  }

  @keyframes pulse-border {
    0%, 100% { border-color: rgb(51, 65, 85); }
    50% { border-color: rgb(100, 116, 139); }
  }

  .island.island-highlighted .island-body {
    border-color: rgb(250, 204, 21);
    box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
  }

  /* Current island indicator */
  .island.island-current .island-body {
    border-color: rgb(250, 204, 21);
  }

  /* Ship marker for current location */
  .ship-marker {
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 24px;
    color: rgb(250, 204, 21);
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    animation: ship-bob 3s ease-in-out infinite;
    z-index: 10;
  }

  .ship-marker svg {
    width: 100%;
    height: 100%;
  }

  @keyframes ship-bob {
    0%, 100% {
      transform: translateX(-50%) translateY(0) rotate(-2deg);
    }
    50% {
      transform: translateX(-50%) translateY(-3px) rotate(2deg);
    }
  }

  /* Legacy current location marker (kept for compatibility) */
  .current-location-marker {
    position: absolute;
    pointer-events: none;
  }

  .marker-pulse {
    position: absolute;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(250, 204, 21, 0.3);
    animation: pulse-expand 2s infinite;
    transform: translate(-50%, -50%);
  }

  .marker-dot {
    position: absolute;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgb(250, 204, 21);
    border: 2px solid white;
    transform: translate(-50%, -50%);
  }

  @keyframes pulse-expand {
    0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
  }

  /* Legend */
  .map-legend {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    padding: 1rem;
    background: rgba(15, 23, 42, 0.8);
    border-top: 1px solid rgb(51, 65, 85);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: rgb(148, 163, 184);
  }

  .legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .legend-available {
    background: rgb(51, 65, 85);
    border: 1px solid rgb(100, 116, 139);
  }

  .legend-in-progress {
    background: rgb(51, 65, 85);
    border: 1px solid rgb(148, 163, 184);
    animation: pulse-border 2s infinite;
  }

  .legend-completed {
    background: rgb(52, 211, 153);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .island {
      width: 60px;
      height: 60px;
    }

    .island-name {
      font-size: 0.5rem;
    }

    .island-topic-count {
      display: none;
    }

    .ship-marker {
      width: 18px;
      height: 18px;
      top: -22px;
    }

    .compass-rose {
      width: 45px;
      height: 45px;
      bottom: 8px;
      left: 8px;
    }

    .map-legend {
      gap: 1rem;
      flex-wrap: wrap;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .island,
    .progress-fill,
    .marker-pulse,
    .ship-marker {
      animation: none;
      transition: none;
    }
  }
</style>
