---
// Active Journey Page - Shows the user's current learning path progress
// Displays step-by-step progress through the selected path

import BaseLayout from '../../layouts/BaseLayout.astro';
import ProgressHeader from '../../components/learn/ProgressHeader.astro';
import fs from 'fs';
import path from 'path';

// Load all learning paths data for client-side use
const learningPathsDir = path.join(process.cwd(), '../learning-paths');

function loadAllPaths() {
  const paths: Record<string, any> = {};
  const categories = ['personas', 'tracks', 'suggested-journeys'];

  categories.forEach(category => {
    const categoryDir = path.join(learningPathsDir, category);
    const files = fs.readdirSync(categoryDir).filter(f => f.endsWith('.json'));

    files.forEach(file => {
      const content = fs.readFileSync(path.join(categoryDir, file), 'utf-8');
      const data = JSON.parse(content);
      // Skip hidden paths
      if (!data.hidden) {
        paths[data.id] = { ...data, category };
      }
    });
  });

  return paths;
}

const allPaths = loadAllPaths();
---

<BaseLayout title="Your Journey | How to Build an App">
  <main class="journey-page">
    <!-- Progress header placeholder - populated by JS -->
    <div id="progress-header-container"></div>

    <!-- Journey content -->
    <div class="journey-content">
      <!-- No active path state -->
      <div class="no-path-state" id="no-path-state">
        <div class="state-content">
          <span class="state-icon">üó∫Ô∏è</span>
          <h2>No Active Journey</h2>
          <p>You haven't started a learning path yet. Choose one to begin your adventure!</p>
          <a href="/learn/paths/" class="btn btn-primary">Browse Learning Paths</a>
        </div>
      </div>

      <!-- Active journey view -->
      <div class="active-journey" id="active-journey" style="display: none;">
        <!-- Path info header -->
        <div class="journey-header">
          <div class="path-info">
            <h1 id="path-name">Loading...</h1>
            <p id="path-description"></p>
          </div>
          <div class="journey-actions">
            <a href="/learn/" class="btn btn-secondary btn-sm">Back to Hub</a>
            <button class="btn btn-outline btn-sm" id="change-path-btn">Change Path</button>
          </div>
        </div>

        <!-- Steps/Milestones list -->
        <div class="journey-steps" id="journey-steps">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </main>

  <!-- Pass paths data to client -->
  <script define:vars={{ allPaths }}>
    window.__LEARNING_PATHS__ = allPaths;
  </script>
</BaseLayout>

<script>
  import { loadProgress, updatePathStep, isTopicCompleted } from '../../utils/progressStore';

  function initJourneyPage() {
    const progress = loadProgress();
    const paths = (window as any).__LEARNING_PATHS__;

    const noPathState = document.getElementById('no-path-state');
    const activeJourney = document.getElementById('active-journey');

    // Check if user has an active path
    if (!progress.currentPathId) {
      noPathState!.style.display = 'flex';
      activeJourney!.style.display = 'none';
      return;
    }

    // Check if path data exists
    const pathData = paths[progress.currentPathId];
    if (!pathData) {
      console.error('Path not found:', progress.currentPathId);
      noPathState!.style.display = 'flex';
      activeJourney!.style.display = 'none';
      return;
    }

    noPathState!.style.display = 'none';
    activeJourney!.style.display = 'block';

    const pathProgress = progress.pathProgress[progress.currentPathId];

    // Update path info
    document.getElementById('path-name')!.textContent = pathData.name;
    document.getElementById('path-description')!.textContent = pathData.description;

    // Render steps
    const stepsContainer = document.getElementById('journey-steps')!;
    stepsContainer.innerHTML = '';

    if (pathData.milestones) {
      // Persona/Track format with milestones
      let stepIndex = 0;

      pathData.milestones.forEach((milestone: any, mIndex: number) => {
        const milestoneEl = document.createElement('div');
        milestoneEl.className = 'milestone-section';

        const milestoneHeader = document.createElement('div');
        milestoneHeader.className = 'milestone-header';
        milestoneHeader.innerHTML = `
          <span class="milestone-number">${mIndex + 1}</span>
          <div class="milestone-info">
            <h3>${milestone.name}</h3>
            <p>${milestone.description || ''}</p>
          </div>
        `;
        milestoneEl.appendChild(milestoneHeader);

        const stepsEl = document.createElement('div');
        stepsEl.className = 'milestone-steps';

        milestone.steps?.forEach((step: any) => {
          const isCompleted = pathProgress?.completedSteps?.includes(stepIndex) || false;
          const isCurrent = pathProgress?.currentStep === stepIndex;
          const topicCompleted = isTopicCompleted(progress, step.phase, step.topic, step.depth);

          const stepEl = createStepElement(step, stepIndex, isCompleted || topicCompleted, isCurrent);
          stepsEl.appendChild(stepEl);
          stepIndex++;
        });

        milestoneEl.appendChild(stepsEl);
        stepsContainer.appendChild(milestoneEl);
      });
    } else {
      // Journey format with simple steps (support both journey_steps and steps)
      const steps = pathData.journey_steps || pathData.steps || [];

      if (steps.length === 0) {
        stepsContainer.innerHTML = '<p class="no-steps">No steps defined for this journey.</p>';
        return;
      }

      const stepsEl = document.createElement('div');
      stepsEl.className = 'journey-steps-list';

      steps.forEach((step: any, index: number) => {
        const isCompleted = pathProgress?.completedSteps?.includes(index) || false;
        const isCurrent = pathProgress?.currentStep === index;
        const topicCompleted = isTopicCompleted(progress, step.phase, step.topic, step.depth);

        const stepEl = createStepElement(step, index, isCompleted || topicCompleted, isCurrent);
        stepsEl.appendChild(stepEl);
      });

      stepsContainer.appendChild(stepsEl);
    }

    // Change path handler
    document.getElementById('change-path-btn')?.addEventListener('click', () => {
      if (confirm('Switch to a different learning path? Your progress will be saved.')) {
        window.location.href = '/learn/paths/';
      }
    });
  }

  function createStepElement(
    step: any,
    index: number,
    isCompleted: boolean,
    isCurrent: boolean
  ): HTMLElement {
    const stepEl = document.createElement('a');
    stepEl.href = `/${step.phase}/${step.topic}/${step.depth}/`;
    stepEl.className = `step-card ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}`;

    const depthLabel = step.depth === 'surface' ? 'S' : step.depth === 'mid-depth' ? 'M' : 'D';
    const topicName = step.topic.replace(/-/g, ' ');

    stepEl.innerHTML = `
      <div class="step-status">
        ${isCompleted
          ? '<span class="status-icon completed">‚úì</span>'
          : isCurrent
            ? '<span class="status-icon current">‚Üí</span>'
            : '<span class="status-icon pending">‚óã</span>'
        }
      </div>
      <div class="step-content">
        <div class="step-main">
          <span class="step-topic">${topicName}</span>
          <span class="step-depth depth-${step.depth}">${depthLabel}</span>
        </div>
        ${step.why ? `<p class="step-why">${step.why}</p>` : ''}
      </div>
      <div class="step-meta">
        <span class="step-time">${step.estimated_minutes}m</span>
        ${step.required ? '<span class="step-required">Required</span>' : ''}
      </div>
    `;

    return stepEl;
  }

  document.addEventListener('DOMContentLoaded', initJourneyPage);

  window.addEventListener('storage', (e) => {
    if (e.key === 'htbaa_learning_progress') {
      initJourneyPage();
    }
  });
</script>

<style>
  .journey-page {
    min-height: 100vh;
  }

  .journey-content {
    max-width: 900px;
    margin: 0 auto;
    padding: 2rem 1.5rem 3rem;
  }

  /* No path state */
  .no-path-state {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 400px;
  }

  .state-content {
    text-align: center;
    max-width: 400px;
  }

  .state-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
  }

  .state-content h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: rgb(241, 245, 249);
    margin: 0 0 0.75rem;
  }

  .state-content p {
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    margin: 0 0 1.5rem;
    line-height: 1.6;
  }

  /* Journey header */
  .journey-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid rgb(51, 65, 85);
  }

  .path-info h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: rgb(241, 245, 249);
    margin: 0 0 0.5rem;
  }

  .path-info p {
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    margin: 0;
    line-height: 1.5;
  }

  .journey-actions {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.625rem 1.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 0.5rem;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    border: none;
  }

  .btn-sm {
    padding: 0.5rem 0.875rem;
    font-size: 0.75rem;
  }

  .btn-primary {
    background: rgb(56, 189, 248);
    color: rgb(15, 23, 42);
  }

  .btn-primary:hover {
    background: rgb(14, 165, 233);
  }

  .btn-secondary {
    background: rgb(51, 65, 85);
    color: rgb(226, 232, 240);
  }

  .btn-secondary:hover {
    background: rgb(71, 85, 105);
  }

  .btn-outline {
    background: transparent;
    color: rgb(148, 163, 184);
    border: 1px solid rgb(51, 65, 85);
  }

  .btn-outline:hover {
    color: rgb(226, 232, 240);
    border-color: rgb(100, 116, 139);
  }

  /* Milestone sections */
  .milestone-section {
    margin-bottom: 2rem;
  }

  .milestone-header {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .milestone-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: rgb(56, 189, 248);
    color: rgb(15, 23, 42);
    font-weight: 700;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .milestone-info h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: rgb(241, 245, 249);
    margin: 0 0 0.25rem;
  }

  .milestone-info p {
    font-size: 0.8125rem;
    color: rgb(148, 163, 184);
    margin: 0;
  }

  .milestone-steps,
  .journey-steps-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-left: 1.25rem;
    padding-left: 1.25rem;
    border-left: 2px solid rgb(51, 65, 85);
  }

  /* Step cards - using :global because these are dynamically created */
  :global(.step-card) {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: rgb(30, 41, 59);
    border: 1px solid rgb(51, 65, 85);
    border-radius: 0.5rem;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  :global(.step-card:hover) {
    border-color: rgb(100, 116, 139);
    transform: translateX(4px);
  }

  :global(.step-card.completed) {
    border-color: rgba(52, 211, 153, 0.3);
    background: rgba(52, 211, 153, 0.05);
  }

  :global(.step-card.current) {
    border-color: rgb(56, 189, 248);
    box-shadow: 0 0 0 1px rgb(56, 189, 248);
  }

  :global(.step-status) {
    flex-shrink: 0;
  }

  :global(.status-icon) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    font-size: 0.75rem;
  }

  :global(.status-icon.completed) {
    background: rgb(52, 211, 153);
    color: rgb(15, 23, 42);
  }

  :global(.status-icon.current) {
    background: rgb(56, 189, 248);
    color: rgb(15, 23, 42);
  }

  :global(.status-icon.pending) {
    color: rgb(100, 116, 139);
    font-size: 1rem;
  }

  :global(.step-content) {
    flex: 1;
    min-width: 0;
  }

  :global(.step-main) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  :global(.step-topic) {
    font-size: 0.875rem;
    font-weight: 600;
    color: rgb(226, 232, 240);
    text-transform: capitalize;
  }

  :global(.step-depth) {
    font-size: 0.5625rem;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-weight: 600;
  }

  :global(.step-depth.depth-surface) {
    background: rgba(52, 211, 153, 0.2);
    color: rgb(52, 211, 153);
  }

  :global(.step-depth.depth-mid-depth) {
    background: rgba(251, 191, 36, 0.2);
    color: rgb(251, 191, 36);
  }

  :global(.step-depth.depth-deep-water) {
    background: rgba(239, 68, 68, 0.2);
    color: rgb(239, 68, 68);
  }

  :global(.step-why) {
    font-size: 0.75rem;
    color: rgb(148, 163, 184);
    margin: 0.5rem 0 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  :global(.step-meta) {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.25rem;
    flex-shrink: 0;
  }

  :global(.step-time) {
    font-size: 0.75rem;
    color: rgb(100, 116, 139);
  }

  :global(.step-required) {
    font-size: 0.5625rem;
    padding: 0.125rem 0.25rem;
    background: rgba(251, 191, 36, 0.2);
    color: rgb(251, 191, 36);
    border-radius: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .journey-content {
      padding: 1.5rem 1rem 2rem;
    }

    .journey-header {
      flex-direction: column;
      gap: 1rem;
    }

    .path-info h1 {
      font-size: 1.5rem;
    }

    .journey-actions {
      width: 100%;
    }

    .journey-actions .btn {
      flex: 1;
    }

    .milestone-header {
      flex-direction: column;
      gap: 0.75rem;
    }

    .milestone-steps,
    .journey-steps-list {
      margin-left: 0;
      padding-left: 1rem;
    }

    .step-card {
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .step-meta {
      width: 100%;
      flex-direction: row;
      justify-content: space-between;
    }
  }
</style>
