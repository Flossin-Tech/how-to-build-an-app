---
// Path Detail Page - Shows full details of a learning path and allows starting
// Dynamic route for persona paths

import BaseLayout from '../../../../layouts/BaseLayout.astro';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  const pathsDir = path.join(process.cwd(), '../learning-paths/personas');
  const files = fs.readdirSync(pathsDir).filter(f => f.endsWith('.json'));

  return files.map(file => {
    const content = fs.readFileSync(path.join(pathsDir, file), 'utf-8');
    const data = JSON.parse(content);
    return {
      params: { pathId: data.id },
      props: { pathData: data, category: 'personas' },
    };
  });
}

const { pathData, category } = Astro.props;

// Calculate total steps and topics
let totalSteps = 0;
const milestones = pathData.milestones || [];
milestones.forEach((m: any) => {
  totalSteps += m.steps?.length || 0;
});

// Build a mapping of path IDs to their categories for related paths
const pathsDir = path.join(process.cwd(), '../learning-paths');
const pathCategories: Record<string, string> = {};

// Load all paths to build the mapping
['personas', 'tracks', 'suggested-journeys'].forEach(cat => {
  const catDir = path.join(pathsDir, cat);
  const files = fs.readdirSync(catDir).filter(f => f.endsWith('.json'));
  files.forEach(file => {
    const content = fs.readFileSync(path.join(catDir, file), 'utf-8');
    const data = JSON.parse(content);
    // Map category name to URL path (suggested-journeys -> journeys)
    const urlCategory = cat === 'suggested-journeys' ? 'journeys' : cat;
    pathCategories[data.id] = urlCategory;
  });
});

// Helper to get path URL
function getPathUrl(pathId: string): string {
  const cat = pathCategories[pathId] || 'personas';
  return `/learn/paths/${cat}/${pathId}/`;
}

// Helper to format path name for display
function formatPathName(pathId: string): string {
  return pathId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

// Build reverse mapping from display names to path IDs for linkifying text
const pathNameToId: Record<string, string> = {};
Object.keys(pathCategories).forEach(id => {
  const displayName = formatPathName(id);
  pathNameToId[displayName] = id;
  pathNameToId[displayName.toLowerCase()] = id;
  // Also handle variations like "New Developer path" -> "new-developer"
  pathNameToId[`${displayName} path`] = id;
  pathNameToId[`${displayName} track`] = id;
  pathNameToId[`${displayName} journey`] = id;
});

// Helper to linkify path references in text
function linkifyPathReferences(text: string): string {
  let result = text;

  // Sort by length descending to match longer phrases first
  const sortedNames = Object.keys(pathNameToId).sort((a, b) => b.length - a.length);

  for (const name of sortedNames) {
    const pathId = pathNameToId[name];
    const url = getPathUrl(pathId);
    // Case-insensitive match
    const regex = new RegExp(name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    result = result.replace(regex, `<a href="${url}" class="inline-link">$&</a>`);
  }

  return result;
}

// Format time
function formatTime(minutes: number): string {
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
}
---

<BaseLayout title={`${pathData.name} | Learning Paths`}>
  <main class="path-detail">
    <!-- Back navigation -->
    <a href="/learn/paths/" class="back-link">‚Üê Back to all paths</a>

    <!-- Path header -->
    <header class="path-header">
      <div class="path-badge">
        <span class="badge-icon">üë§</span>
        <span>Persona Path</span>
      </div>
      <h1>{pathData.name}</h1>
      <p class="path-description">{pathData.description}</p>

      <!-- Stats -->
      <div class="path-stats">
        <div class="stat">
          <span class="stat-value">{formatTime(pathData.estimated_total_time_minutes)}</span>
          <span class="stat-label">Total Time</span>
        </div>
        <div class="stat">
          <span class="stat-value">{totalSteps}</span>
          <span class="stat-label">Topics</span>
        </div>
        <div class="stat">
          <span class="stat-value">{milestones.length}</span>
          <span class="stat-label">Milestones</span>
        </div>
      </div>
    </header>

    <!-- CTA Section -->
    <div class="cta-section">
      <button
        class="start-path-btn"
        data-path-id={pathData.id}
        data-category={category}
      >
        Start This Journey
      </button>
      <p class="cta-note">Your progress will be saved automatically</p>
    </div>

    <!-- Objectives -->
    {pathData.objectives && pathData.objectives.length > 0 && (
      <section class="section objectives-section">
        <h2>What You'll Learn</h2>
        <ul class="objectives-list">
          {pathData.objectives.map((obj: string) => (
            <li>{obj}</li>
          ))}
        </ul>
      </section>
    )}

    <!-- Prerequisites -->
    {pathData.prerequisites && pathData.prerequisites.length > 0 && (
      <section class="section prerequisites-section">
        <h2>Prerequisites</h2>
        <ul class="prerequisites-list">
          {pathData.prerequisites.map((prereq: string) => (
            <li>{prereq}</li>
          ))}
        </ul>
      </section>
    )}

    <!-- Milestones breakdown -->
    <section class="section milestones-section">
      <h2>Journey Milestones</h2>
      <div class="milestones-list">
        {milestones.map((milestone: any, index: number) => (
          <div class="milestone-card">
            <div class="milestone-header">
              <span class="milestone-number">{index + 1}</span>
              <div class="milestone-info">
                <h3>{milestone.name}</h3>
                <p>{milestone.description}</p>
              </div>
            </div>
            <div class="milestone-steps">
              {milestone.steps?.map((step: any) => (
                <div class="step-item">
                  <span class={`step-depth depth-${step.depth || 'surface'}`}>
                    {step.depth === 'surface' ? 'S' : step.depth === 'mid-depth' ? 'M' : 'D'}
                  </span>
                  <span class="step-topic">{(step.topic || 'Unknown').replace(/-/g, ' ')}</span>
                  <span class="step-time">{step.estimated_minutes || 10}m</span>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>

    <!-- Completion criteria -->
    {pathData.completion_criteria && pathData.completion_criteria.length > 0 && (
      <section class="section completion-section">
        <h2>Completion Criteria</h2>
        <ul class="completion-list">
          {pathData.completion_criteria.map((criteria: string) => (
            <li>{criteria}</li>
          ))}
        </ul>
      </section>
    )}

    <!-- Next steps -->
    {pathData.next_steps && pathData.next_steps.length > 0 && (
      <section class="section next-steps-section">
        <h2>What's Next</h2>
        <p class="section-intro">After completing this path, you might want to:</p>
        <ul class="next-steps-list">
          {pathData.next_steps.map((step: string) => (
            <li set:html={linkifyPathReferences(step)} />
          ))}
        </ul>
      </section>
    )}

    <!-- Related paths -->
    {pathData.related_paths && pathData.related_paths.length > 0 && (
      <section class="section related-section">
        <h2>Related Paths</h2>
        <div class="related-links">
          {pathData.related_paths.map((relatedId: string) => (
            <a href={getPathUrl(relatedId)} class="related-tag">{formatPathName(relatedId)}</a>
          ))}
        </div>
      </section>
    )}
  </main>
</BaseLayout>

<script>
  import { loadProgress, startPath, saveProgress } from '../../../../utils/progressStore';

  function initPathDetail() {
    const startBtn = document.querySelector('.start-path-btn');
    if (!startBtn) return;

    const pathId = startBtn.getAttribute('data-path-id');
    const category = startBtn.getAttribute('data-category') as 'personas' | 'tracks' | 'journeys';

    if (!pathId || !category) return;

    // Check if already started
    const progress = loadProgress();
    if (progress.pathProgress[pathId]) {
      startBtn.textContent = progress.currentPathId === pathId ? 'Continue Journey' : 'Resume Journey';
    }

    startBtn.addEventListener('click', () => {
      let currentProgress = loadProgress();

      // Start or switch to this path
      currentProgress = startPath(currentProgress, pathId, category);

      // Navigate to the journey view
      window.location.href = '/learn/journey/';
    });
  }

  document.addEventListener('DOMContentLoaded', initPathDetail);
</script>

<style>
  .path-detail {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem 1.5rem 3rem;
  }

  .back-link {
    display: inline-block;
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    text-decoration: none;
    margin-bottom: 1.5rem;
  }

  .back-link:hover {
    color: rgb(56, 189, 248);
  }

  /* Header */
  .path-header {
    text-align: center;
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid rgb(51, 65, 85);
  }

  .path-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: rgba(56, 189, 248, 0.1);
    border: 1px solid rgba(56, 189, 248, 0.3);
    border-radius: 2rem;
    font-size: 0.75rem;
    color: rgb(56, 189, 248);
    margin-bottom: 1rem;
  }

  .badge-icon {
    font-size: 0.875rem;
  }

  .path-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: rgb(241, 245, 249);
    margin: 0 0 1rem;
  }

  .path-description {
    font-size: 1rem;
    color: rgb(148, 163, 184);
    line-height: 1.6;
    margin: 0 0 1.5rem;
  }

  .path-stats {
    display: flex;
    justify-content: center;
    gap: 2rem;
  }

  .stat {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: rgb(226, 232, 240);
  }

  .stat-label {
    font-size: 0.625rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: rgb(100, 116, 139);
  }

  /* CTA */
  .cta-section {
    text-align: center;
    margin-bottom: 2rem;
  }

  .start-path-btn {
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    color: rgb(15, 23, 42);
    background: rgb(56, 189, 248);
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .start-path-btn:hover {
    background: rgb(14, 165, 233);
    transform: translateY(-1px);
  }

  .cta-note {
    font-size: 0.75rem;
    color: rgb(100, 116, 139);
    margin: 0.5rem 0 0;
  }

  /* Sections */
  .section {
    margin-bottom: 2rem;
  }

  .section h2 {
    font-size: 1.25rem;
    font-weight: 600;
    color: rgb(241, 245, 249);
    margin: 0 0 1rem;
  }

  .section-intro {
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    margin: 0 0 0.75rem;
  }

  /* Lists */
  .objectives-list,
  .prerequisites-list,
  .completion-list,
  .next-steps-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .objectives-list li,
  .prerequisites-list li,
  .completion-list li,
  .next-steps-list li {
    position: relative;
    padding-left: 1.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: rgb(148, 163, 184);
    line-height: 1.5;
  }

  .objectives-list li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    color: rgb(52, 211, 153);
  }

  .prerequisites-list li::before {
    content: '‚Ä¢';
    position: absolute;
    left: 0;
    color: rgb(251, 191, 36);
  }

  .completion-list li::before {
    content: '‚òê';
    position: absolute;
    left: 0;
    color: rgb(100, 116, 139);
  }

  .next-steps-list li::before {
    content: '‚Üí';
    position: absolute;
    left: 0;
    color: rgb(56, 189, 248);
  }

  .inline-link {
    color: rgb(56, 189, 248);
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .inline-link:hover {
    color: rgb(125, 211, 252);
    text-decoration: underline;
  }

  /* Milestones */
  .milestones-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .milestone-card {
    background: rgb(30, 41, 59);
    border: 1px solid rgb(51, 65, 85);
    border-radius: 0.75rem;
    overflow: hidden;
  }

  .milestone-header {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: rgba(51, 65, 85, 0.3);
  }

  .milestone-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    background: rgb(56, 189, 248);
    color: rgb(15, 23, 42);
    font-weight: 700;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .milestone-info h3 {
    font-size: 1rem;
    font-weight: 600;
    color: rgb(241, 245, 249);
    margin: 0 0 0.25rem;
  }

  .milestone-info p {
    font-size: 0.8125rem;
    color: rgb(148, 163, 184);
    margin: 0;
    line-height: 1.4;
  }

  .milestone-steps {
    padding: 0.75rem 1rem;
  }

  .step-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgb(51, 65, 85);
  }

  .step-item:last-child {
    border-bottom: none;
  }

  .step-depth {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.625rem;
    font-weight: 700;
    border-radius: 0.25rem;
    flex-shrink: 0;
  }

  .step-depth.depth-surface {
    background: rgba(52, 211, 153, 0.2);
    color: rgb(52, 211, 153);
  }

  .step-depth.depth-mid-depth {
    background: rgba(251, 191, 36, 0.2);
    color: rgb(251, 191, 36);
  }

  .step-depth.depth-deep-water {
    background: rgba(239, 68, 68, 0.2);
    color: rgb(239, 68, 68);
  }

  .step-topic {
    flex: 1;
    font-size: 0.8125rem;
    color: rgb(148, 163, 184);
    text-transform: capitalize;
  }

  .step-time {
    font-size: 0.75rem;
    color: rgb(100, 116, 139);
  }

  /* Related */
  .related-links {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .related-tag {
    padding: 0.375rem 0.75rem;
    background: rgba(51, 65, 85, 0.5);
    border-radius: 0.375rem;
    font-size: 0.75rem;
    color: rgb(148, 163, 184);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .related-tag:hover {
    background: rgba(56, 189, 248, 0.2);
    color: rgb(56, 189, 248);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .path-detail {
      padding: 1.5rem 1rem 2rem;
    }

    .path-header h1 {
      font-size: 1.5rem;
    }

    .path-stats {
      gap: 1rem;
    }

    .stat-value {
      font-size: 1.25rem;
    }

    .milestone-header {
      flex-direction: column;
      gap: 0.75rem;
    }
  }
</style>
