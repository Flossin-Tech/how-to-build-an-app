---
// Path Detail Page for Tracks
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import fs from 'fs';
import path from 'path';

export async function getStaticPaths() {
  const pathsDir = path.join(process.cwd(), '../learning-paths/tracks');
  const files = fs.readdirSync(pathsDir).filter(f => f.endsWith('.json'));

  return files.map(file => {
    const content = fs.readFileSync(path.join(pathsDir, file), 'utf-8');
    const data = JSON.parse(content);
    return {
      params: { pathId: data.id },
      props: { pathData: data, category: 'tracks' },
    };
  });
}

const { pathData, category } = Astro.props;

let totalSteps = 0;
const milestones = pathData.milestones || [];
milestones.forEach((m: any) => {
  totalSteps += m.steps?.length || 0;
});

function formatTime(minutes: number): string {
  if (minutes < 60) return `${minutes} min`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
}
---

<BaseLayout title={`${pathData.name} | Learning Paths`}>
  <main class="path-detail">
    <a href="/learn/paths/" class="back-link">‚Üê Back to all paths</a>

    <header class="path-header">
      <div class="path-badge track-badge">
        <span class="badge-icon">üéØ</span>
        <span>Goal Track</span>
      </div>
      <h1>{pathData.name}</h1>
      <p class="path-description">{pathData.description}</p>

      <div class="path-stats">
        <div class="stat">
          <span class="stat-value">{formatTime(pathData.estimated_total_time_minutes)}</span>
          <span class="stat-label">Total Time</span>
        </div>
        <div class="stat">
          <span class="stat-value">{totalSteps}</span>
          <span class="stat-label">Topics</span>
        </div>
        <div class="stat">
          <span class="stat-value">{milestones.length}</span>
          <span class="stat-label">Milestones</span>
        </div>
      </div>
    </header>

    <div class="cta-section">
      <button class="start-path-btn" data-path-id={pathData.id} data-category={category}>
        Start This Track
      </button>
      <p class="cta-note">Your progress will be saved automatically</p>
    </div>

    {pathData.objectives && pathData.objectives.length > 0 && (
      <section class="section">
        <h2>What You'll Learn</h2>
        <ul class="objectives-list">
          {pathData.objectives.map((obj: string) => <li>{obj}</li>)}
        </ul>
      </section>
    )}

    <section class="section">
      <h2>Track Milestones</h2>
      <div class="milestones-list">
        {milestones.map((milestone: any, index: number) => (
          <div class="milestone-card">
            <div class="milestone-header">
              <span class="milestone-number">{index + 1}</span>
              <div class="milestone-info">
                <h3>{milestone.name}</h3>
                <p>{milestone.description}</p>
              </div>
            </div>
            <div class="milestone-steps">
              {milestone.steps?.map((step: any) => (
                <div class="step-item">
                  <span class={`step-depth depth-${step.depth || 'surface'}`}>
                    {step.depth === 'surface' ? 'S' : step.depth === 'mid-depth' ? 'M' : 'D'}
                  </span>
                  <span class="step-topic">{(step.topic || 'Unknown').replace(/-/g, ' ')}</span>
                  <span class="step-time">{step.estimated_minutes || 10}m</span>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </section>
  </main>
</BaseLayout>

<script>
  import { loadProgress, startPath } from '../../../../utils/progressStore';

  function initPathDetail() {
    const startBtn = document.querySelector('.start-path-btn');
    if (!startBtn) return;

    const pathId = startBtn.getAttribute('data-path-id');
    const category = startBtn.getAttribute('data-category') as 'tracks';

    if (!pathId) return;

    const progress = loadProgress();
    if (progress.pathProgress[pathId]) {
      startBtn.textContent = progress.currentPathId === pathId ? 'Continue Track' : 'Resume Track';
    }

    startBtn.addEventListener('click', () => {
      let currentProgress = loadProgress();
      currentProgress = startPath(currentProgress, pathId, category);
      window.location.href = '/learn/journey/';
    });
  }

  document.addEventListener('DOMContentLoaded', initPathDetail);
</script>

<style>
  .path-detail { max-width: 800px; margin: 0 auto; padding: 2rem 1.5rem 3rem; }
  .back-link { display: inline-block; font-size: 0.875rem; color: rgb(148, 163, 184); text-decoration: none; margin-bottom: 1.5rem; }
  .back-link:hover { color: rgb(167, 139, 250); }
  .path-header { text-align: center; margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 1px solid rgb(51, 65, 85); }
  .path-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.375rem 0.75rem; border-radius: 2rem; font-size: 0.75rem; margin-bottom: 1rem; }
  .track-badge { background: rgba(167, 139, 250, 0.1); border: 1px solid rgba(167, 139, 250, 0.3); color: rgb(167, 139, 250); }
  .badge-icon { font-size: 0.875rem; }
  .path-header h1 { font-size: 2rem; font-weight: 700; color: rgb(241, 245, 249); margin: 0 0 1rem; }
  .path-description { font-size: 1rem; color: rgb(148, 163, 184); line-height: 1.6; margin: 0 0 1.5rem; }
  .path-stats { display: flex; justify-content: center; gap: 2rem; }
  .stat { display: flex; flex-direction: column; align-items: center; }
  .stat-value { font-size: 1.5rem; font-weight: 700; color: rgb(226, 232, 240); }
  .stat-label { font-size: 0.625rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgb(100, 116, 139); }
  .cta-section { text-align: center; margin-bottom: 2rem; }
  .start-path-btn { padding: 1rem 2rem; font-size: 1rem; font-weight: 600; color: rgb(15, 23, 42); background: rgb(167, 139, 250); border: none; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; }
  .start-path-btn:hover { background: rgb(139, 92, 246); transform: translateY(-1px); }
  .cta-note { font-size: 0.75rem; color: rgb(100, 116, 139); margin: 0.5rem 0 0; }
  .section { margin-bottom: 2rem; }
  .section h2 { font-size: 1.25rem; font-weight: 600; color: rgb(241, 245, 249); margin: 0 0 1rem; }
  .objectives-list { list-style: none; padding: 0; margin: 0; }
  .objectives-list li { position: relative; padding-left: 1.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; color: rgb(148, 163, 184); line-height: 1.5; }
  .objectives-list li::before { content: '‚úì'; position: absolute; left: 0; color: rgb(167, 139, 250); }
  .milestones-list { display: flex; flex-direction: column; gap: 1rem; }
  .milestone-card { background: rgb(30, 41, 59); border: 1px solid rgb(51, 65, 85); border-radius: 0.75rem; overflow: hidden; }
  .milestone-header { display: flex; gap: 1rem; padding: 1rem; background: rgba(51, 65, 85, 0.3); }
  .milestone-number { display: flex; align-items: center; justify-content: center; width: 2rem; height: 2rem; background: rgb(167, 139, 250); color: rgb(15, 23, 42); font-weight: 700; border-radius: 50%; flex-shrink: 0; }
  .milestone-info h3 { font-size: 1rem; font-weight: 600; color: rgb(241, 245, 249); margin: 0 0 0.25rem; }
  .milestone-info p { font-size: 0.8125rem; color: rgb(148, 163, 184); margin: 0; line-height: 1.4; }
  .milestone-steps { padding: 0.75rem 1rem; }
  .step-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid rgb(51, 65, 85); }
  .step-item:last-child { border-bottom: none; }
  .step-depth { width: 1.5rem; height: 1.5rem; display: flex; align-items: center; justify-content: center; font-size: 0.625rem; font-weight: 700; border-radius: 0.25rem; flex-shrink: 0; }
  .step-depth.depth-surface { background: rgba(52, 211, 153, 0.2); color: rgb(52, 211, 153); }
  .step-depth.depth-mid-depth { background: rgba(251, 191, 36, 0.2); color: rgb(251, 191, 36); }
  .step-depth.depth-deep-water { background: rgba(239, 68, 68, 0.2); color: rgb(239, 68, 68); }
  .step-topic { flex: 1; font-size: 0.8125rem; color: rgb(148, 163, 184); text-transform: capitalize; }
  .step-time { font-size: 0.75rem; color: rgb(100, 116, 139); }
  @media (max-width: 768px) { .path-detail { padding: 1.5rem 1rem 2rem; } .path-header h1 { font-size: 1.5rem; } }
</style>
